---
import Layout from '../layouts/Layout.astro';
import companiesData from '../data/companies.json';

const companies = companiesData.companies;

// SEO metadata
const pageTitle = "Global Map | XMAQUINA Market Cap";
const pageDescription = "Explore humanoid robotics companies worldwide on an interactive 3D globe. See company locations from Tesla to Figure AI.";
---

<Layout title={pageTitle} description={pageDescription}>
  <div class="globe-page">
    <div class="globe-header">
      <h1>Global Presence</h1>
      <p>Explore humanoid robotics companies worldwide</p>
    </div>

    <div class="globe-container" id="globe-container">
      <div class="globe-loading" id="globe-loading">
        <div class="loading-spinner"></div>
        <span>Loading globe...</span>
      </div>
    </div>

    <div class="company-tooltip" id="company-tooltip">
      <div class="tooltip-content">
        <div class="tooltip-header">
          <img id="tooltip-logo" src="" alt="" class="tooltip-logo" />
          <div class="tooltip-info">
            <h3 id="tooltip-name"></h3>
            <span id="tooltip-robot"></span>
          </div>
        </div>
        <div class="tooltip-details">
          <span id="tooltip-location"></span>
          <span id="tooltip-valuation"></span>
        </div>
      </div>
    </div>

    <div class="globe-legend">
      <div class="legend-item">
        <span class="legend-dot public"></span>
        <span>Public Company</span>
      </div>
      <div class="legend-item">
        <span class="legend-dot private"></span>
        <span>Private Company</span>
      </div>
    </div>

    <div class="globe-stats">
      <div class="stat">
        <span class="stat-value">{companies.length}</span>
        <span class="stat-label">Companies</span>
      </div>
      <div class="stat">
        <span class="stat-value">{[...new Set(companies.map(c => c.country))].length}</span>
        <span class="stat-label">Countries</span>
      </div>
    </div>
  </div>
</Layout>

<script define:vars={{ companies: JSON.stringify(companies) }}>
  // Import Three.js from CDN
  const script = document.createElement('script');
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js';
  script.onload = initGlobe;
  document.head.appendChild(script);

  function initGlobe() {
    const companiesData = JSON.parse(companies);
    const container = document.getElementById('globe-container');
    const loading = document.getElementById('globe-loading');
    const tooltip = document.getElementById('company-tooltip');

    if (!container) return;

    // Scene setup
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
    camera.position.z = 3;

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    container.appendChild(renderer.domElement);

    // Check theme
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

    // Globe with earth texture
    const globeGeometry = new THREE.SphereGeometry(1, 64, 64);
    const textureLoader = new THREE.TextureLoader();

    // Load earth topology texture (dark water, light land)
    const earthTexture = textureLoader.load(
      'https://unpkg.com/three-globe@2.31.0/example/img/earth-topology.png'
    );

    // Main globe with texture (fully opaque)
    const globeMaterial = new THREE.MeshBasicMaterial({
      map: earthTexture
    });
    const texturedGlobe = new THREE.Mesh(globeGeometry, globeMaterial);
    scene.add(texturedGlobe);

    // Atmosphere glow
    const atmosphereGeometry = new THREE.SphereGeometry(1.02, 64, 64);
    const atmosphereMaterial = new THREE.MeshBasicMaterial({
      color: isDark ? 0x1ED612 : 0x1ED612,
      transparent: true,
      opacity: 0.05,
      side: THREE.BackSide
    });
    const atmosphere = new THREE.Mesh(atmosphereGeometry, atmosphereMaterial);
    scene.add(atmosphere);

    // Subtle wireframe overlay
    const wireframeMaterial = new THREE.MeshBasicMaterial({
      color: isDark ? 0x1ED612 : 0x1ED612,
      wireframe: true,
      transparent: true,
      opacity: 0.03
    });
    const wireframeGlobe = new THREE.Mesh(new THREE.SphereGeometry(1.005, 32, 32), wireframeMaterial);
    scene.add(wireframeGlobe);

    // Company markers
    const markers = [];
    const markerGroup = new THREE.Group();

    companiesData.forEach((company) => {
      if (!company.coordinates) return;

      const { lat, lng } = company.coordinates;
      const position = latLngToVector3(lat, lng, 1.02);

      // Marker
      const markerGeometry = new THREE.SphereGeometry(0.02, 16, 16);
      const markerMaterial = new THREE.MeshBasicMaterial({
        color: company.type === 'public' ? 0x1ED612 : 0xffffff
      });
      const marker = new THREE.Mesh(markerGeometry, markerMaterial);
      marker.position.copy(position);
      marker.userData = company;
      markerGroup.add(marker);
      markers.push(marker);

      // Pulse ring for public companies
      if (company.type === 'public') {
        const ringGeometry = new THREE.RingGeometry(0.025, 0.035, 32);
        const ringMaterial = new THREE.MeshBasicMaterial({
          color: 0x1ED612,
          transparent: true,
          opacity: 0.5,
          side: THREE.DoubleSide
        });
        const ring = new THREE.Mesh(ringGeometry, ringMaterial);
        ring.position.copy(position);
        ring.lookAt(0, 0, 0);
        ring.userData = { isPulse: true, baseScale: 1 };
        markerGroup.add(ring);
      }
    });

    scene.add(markerGroup);

    // Convert lat/lng to 3D position
    function latLngToVector3(lat, lng, radius) {
      const phi = (90 - lat) * Math.PI / 180;
      const theta = (lng + 180) * Math.PI / 180;
      return new THREE.Vector3(
        -radius * Math.sin(phi) * Math.cos(theta),
        radius * Math.cos(phi),
        radius * Math.sin(phi) * Math.sin(theta)
      );
    }

    // Raycaster for interaction
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    let hoveredMarker = null;

    container.addEventListener('mousemove', (event) => {
      const rect = container.getBoundingClientRect();
      mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
      mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects(markers);

      if (intersects.length > 0) {
        const marker = intersects[0].object;
        if (hoveredMarker !== marker) {
          hoveredMarker = marker;
          showTooltip(marker.userData, event.clientX, event.clientY);
          container.style.cursor = 'pointer';
        }
      } else {
        if (hoveredMarker) {
          hoveredMarker = null;
          hideTooltip();
          container.style.cursor = 'grab';
        }
      }
    });

    container.addEventListener('click', () => {
      if (hoveredMarker) {
        window.location.href = `/company/${hoveredMarker.userData.id}`;
      }
    });

    // Companies with SVG logos
    const svgLogos = ['neura-robotics'];
    function getLogoPath(companyId) {
      return `/logos/${companyId}.${svgLogos.includes(companyId) ? 'svg' : 'ico'}`;
    }

    // Tooltip functions
    function showTooltip(company, x, y) {
      document.getElementById('tooltip-logo').src = getLogoPath(company.id);
      document.getElementById('tooltip-name').textContent = company.name;
      document.getElementById('tooltip-robot').textContent = company.flagshipRobot;
      document.getElementById('tooltip-location').textContent = company.headquarters;

      let valuation = 'Private';
      if (company.valuationManual) {
        valuation = formatValuation(company.valuationManual);
      } else if (company.type === 'public') {
        valuation = 'Public';
      }
      document.getElementById('tooltip-valuation').textContent = valuation;

      tooltip.style.left = `${x + 15}px`;
      tooltip.style.top = `${y - 20}px`;
      tooltip.classList.add('visible');
    }

    function hideTooltip() {
      tooltip.classList.remove('visible');
    }

    function formatValuation(value) {
      if (value >= 1e12) return `$${(value / 1e12).toFixed(2)}T`;
      if (value >= 1e9) return `$${(value / 1e9).toFixed(2)}B`;
      if (value >= 1e6) return `$${(value / 1e6).toFixed(0)}M`;
      return `$${value.toLocaleString()}`;
    }

    // Mouse drag rotation
    let isDragging = false;
    let previousMousePosition = { x: 0, y: 0 };
    let rotationVelocity = { x: 0, y: 0 };

    container.addEventListener('mousedown', (e) => {
      isDragging = true;
      previousMousePosition = { x: e.clientX, y: e.clientY };
      container.style.cursor = 'grabbing';
    });

    document.addEventListener('mouseup', () => {
      isDragging = false;
      container.style.cursor = 'grab';
    });

    document.addEventListener('mousemove', (e) => {
      if (!isDragging) return;

      const deltaX = e.clientX - previousMousePosition.x;
      const deltaY = e.clientY - previousMousePosition.y;

      rotationVelocity.x = deltaY * 0.005;
      rotationVelocity.y = deltaX * 0.005;

      previousMousePosition = { x: e.clientX, y: e.clientY };
    });

    // Animation
    let time = 0;
    function animate() {
      requestAnimationFrame(animate);
      time += 0.01;

      // Auto rotation when not dragging (slow rotation)
      if (!isDragging) {
        markerGroup.rotation.y += 0.0005;
        wireframeGlobe.rotation.y += 0.0005;
        texturedGlobe.rotation.y += 0.0005;

        // Apply velocity decay
        rotationVelocity.x *= 0.95;
        rotationVelocity.y *= 0.95;
      }

      // Apply drag rotation
      markerGroup.rotation.y += rotationVelocity.y;
      markerGroup.rotation.x += rotationVelocity.x;
      wireframeGlobe.rotation.y += rotationVelocity.y;
      wireframeGlobe.rotation.x += rotationVelocity.x;
      texturedGlobe.rotation.y += rotationVelocity.y;
      texturedGlobe.rotation.x += rotationVelocity.x;

      // Sync grid rotation
      scene.children.forEach(child => {
        if (child.type === 'Line') {
          child.rotation.y = wireframeGlobe.rotation.y;
          child.rotation.x = wireframeGlobe.rotation.x;
        }
      });

      // Pulse animation for rings
      markerGroup.children.forEach(child => {
        if (child.userData?.isPulse) {
          const scale = 1 + Math.sin(time * 2) * 0.3;
          child.scale.set(scale, scale, scale);
          child.material.opacity = 0.5 - Math.sin(time * 2) * 0.3;
        }
      });

      renderer.render(scene, camera);
    }

    // Handle resize
    window.addEventListener('resize', () => {
      camera.aspect = container.clientWidth / container.clientHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(container.clientWidth, container.clientHeight);
    });

    // Theme change handler
    const observer = new MutationObserver(() => {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      wireframeMaterial.color.setHex(isDark ? 0x1ED612 : 0x1ED612);
    });
    observer.observe(document.documentElement, { attributes: true });

    // Hide loading, start animation
    loading.style.display = 'none';
    container.style.cursor = 'grab';
    animate();
  }
</script>

<style>
  .globe-page {
    min-height: calc(100vh - 120px);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--spacing-xl) var(--spacing-lg);
  }

  .globe-header {
    text-align: center;
    margin-bottom: var(--spacing-xl);
  }

  .globe-header h1 {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: var(--spacing-sm);
    letter-spacing: -0.02em;
  }

  .globe-header p {
    color: var(--color-text-muted);
    font-size: 1rem;
  }

  .globe-container {
    width: 100%;
    max-width: 800px;
    height: 500px;
    position: relative;
    border: 1px solid var(--color-border);
    border-radius: 0;
    overflow: hidden;
    background: var(--color-surface);
  }

  .globe-loading {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-md);
    color: var(--color-text-muted);
  }

  .company-tooltip {
    position: fixed;
    z-index: 1000;
    pointer-events: none;
    opacity: 0;
    transform: translateY(5px);
    transition: opacity 0.2s, transform 0.2s;
  }

  .company-tooltip.visible {
    opacity: 1;
    transform: translateY(0);
  }

  .tooltip-content {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 0;
    padding: var(--spacing-md);
    box-shadow: var(--shadow-lg);
    min-width: 200px;
  }

  .tooltip-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-sm);
  }

  .tooltip-logo {
    width: 32px;
    height: 32px;
    border-radius: 0;
    background: var(--color-bg-secondary);
    object-fit: contain;
  }

  .tooltip-info h3 {
    font-size: 0.875rem;
    font-weight: 600;
    margin: 0;
  }

  .tooltip-info span {
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  .tooltip-details {
    display: flex;
    flex-direction: column;
    gap: 2px;
    font-size: 0.75rem;
    color: var(--color-text-secondary);
    padding-top: var(--spacing-sm);
    border-top: 1px solid var(--color-border);
  }

  .globe-legend {
    display: flex;
    gap: var(--spacing-xl);
    margin-top: var(--spacing-lg);
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-size: 0.875rem;
    color: var(--color-text-secondary);
  }

  .legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
  }

  .legend-dot.public {
    background: #1ED612;
  }

  .legend-dot.private {
    background: var(--color-text);
  }

  .globe-stats {
    display: flex;
    gap: var(--spacing-2xl);
    margin-top: var(--spacing-xl);
    padding-top: var(--spacing-xl);
    border-top: 1px solid var(--color-border);
  }

  .globe-stats .stat {
    text-align: center;
  }

  .globe-stats .stat-value {
    display: block;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-text);
  }

  .globe-stats .stat-label {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  @media (max-width: 768px) {
    .globe-container {
      height: 400px;
    }

    .globe-header h1 {
      font-size: 1.5rem;
    }
  }
</style>
